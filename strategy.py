import indicator
import pandas as pd


def dpo_strategy(ohlcv: pd.DataFrame, n=20):
    dpo_value = indicator.DPO(ohlcv, n=n)
    direct = 'buy' if dpo_value > 0 else 'sell'
    return direct


def maamt_strategy(ohlcv: pd.DataFrame, n=40):
    maamt, volume = indicator.MAAMT(ohlcv, n=n)
    direct = 'buy' if volume > maamt else 'sell'
    return direct


def tii_strategy(ohlcv: pd.DataFrame, n1=40, n2=9):
    tii, tii_signal = indicator.TII(ohlcv, n1=n1, n2=n2)
    direct = 'buy' if tii > tii_signal else 'sell'
    return direct


def er_strategy(ohlcv: pd.DataFrame, n=20):
    direct = ''
    back_day = -1
    bull_power, bear_power = indicator.ER(ohlcv, n=n)
    if bear_power > 0:
        direct = 'buy'
    if bull_power < 0:
        direct = 'sell'
    while direct == '':
        bull_power, bear_power = indicator.ER(ohlcv[:back_day], n=n)
        if bear_power > 0:
            direct = 'buy'
        if bull_power < 0:
            direct = 'sell'
        back_day = back_day - 1
    return direct


def po_strategy(ohlcv: pd.DataFrame, short=20, long=9):
    po_value = indicator.po(ohlcv=ohlcv, short_n=short, long_n=long)
    direct = 'buy' if po_value > 0 else 'sell'
    return direct


def pos_strategy(ohlcv: pd.DataFrame, n=100):
    direct = ''
    back_day = -1
    pos_value = indicator.pos(ohlcv=ohlcv, n=n)
    if pos_value > 80:
        direct = 'buy'
    if pos_value < 20:
        direct = 'sell'
    while direct == '':
        pos_value = indicator.pos(ohlcv=ohlcv[:back_day], n=n)
        if pos_value > 80:
            direct = 'buy'
        if pos_value < 20:
            direct = 'sell'
        back_day = back_day - 1
    return direct


def adtm_strategy(ohlcv: pd.DataFrame, n=20):
    direct = ''
    back_day = -1
    adtm_value = indicator.adtm(ohlcv=ohlcv, n=n)
    if adtm_value > 0.5:
        direct = 'buy'
    if adtm_value < -0.5:
        direct = 'sell'
    while direct == '':
        adtm_value = indicator.adtm(ohlcv=ohlcv[:back_day], n=n)
        if adtm_value > 0.5:
            direct = 'buy'
        if adtm_value < -0.5:
            direct = 'sell'
        back_day = back_day - 1
    return direct


def ma_strategy(ohlcv: pd.DataFrame, slow=20, fast=5):
    ma1 = indicator.ma(ohlcv=ohlcv, n=slow)
    ma2 = indicator.ma(ohlcv=ohlcv, n=fast)
    direct = 'buy' if ma2 > ma1 else 'sell'
    return direct


def ma_cross_strategy(ohlcv: pd.DataFrame, n=5):
    ma = indicator.ma(ohlcv=ohlcv, n=n)
    close = ohlcv['close'].tolist()[-1]
    direct = 'buy' if close > ma else 'sell'
    return direct


def strategy_combine(etf_data: pd.DataFrame):
    tii = tii_strategy(etf_data)
    # er = er_strategy(etf_data)
    # maamt = maamt_strategy(etf_data)
    dpo = dpo_strategy(etf_data)
    # ma20 = ma_cross_strategy(etf_data, n=20)
    ma5 = ma_cross_strategy(etf_data, n=20)
    # adtm = adtm_strategy(ohlcv=etf_data)
    # pos = pos_strategy(ohlcv=etf_data)
    # po = po_strategy(ohlcv=etf_data)
    # return [tii, maamt, dpo]
    # 1.6
    # return [tii, er, maamt, dpo]  #胜率: 0.3739130434782609 败率: 0.6260869565217392 盈亏比: 2.2802850351731516
    # 1.5
    # return [er, maamt, dpo] # 胜率: 0.371900826446281 败率: 0.628099173553719 盈亏比: 2.1608333617392135
    # 1.81742
    # return [tii, maamt, dpo]  # 胜率: 0.3816793893129771 败率: 0.6183206106870229 盈亏比: 2.3604458652855973
    # .53
    # 胜率: 0.3235294117647059 败率: 0.6764705882352942 盈亏比: 2.0789329373182297
    # return [tii, er, dpo]
    # 1.67
    # return [tii, er, maamt]  # 胜率: 0.3793103448275862 败率: 0.6206896551724138 盈亏比: 2.1514593076326016
    # 1.34
    # return [dpo] # 胜率: 0.3291139240506329 败率: 0.6708860759493671 盈亏比: 1.9961507815587536
    # 1.0
    # return [er] #  胜率: 0.2894736842105263 败率: 0.7105263157894737 盈亏比: 1.622503803423686
    # 1.66
    # return [maamt]  # 胜率: 0.45098039215686275 败率: 0.5490196078431373 盈亏比: 1.594721787384113
    # 1.5
    # return [tii]  # 胜率: 0.4714285714285714 败率: 0.5285714285714286 盈亏比: 1.7657201588535132
    # 1.56
    # return [dpo, maamt] # 胜率: 0.391304347826087 败率: 0.6086956521739131 盈亏比: 2.1270387285995613
    # 1.26
    # return [dpo, er] # 胜率: 0.3108108108108108 败率: 0.6891891891891891 盈亏比: 1.909201015635396
    # 1.75
    # return [dpo, tii]  # 胜率: 0.3108108108108108 败率: 0.6891891891891891 盈亏比: 2.2012029435186897
    # 1.8319
    # return [tii, maamt]  # 胜率: 0.4268292682926829 败率: 0.573170731707317 盈亏比: 1.8585261302548868
    # 1.59
    # return [tii, er]  # 胜率: 0.30303030303030304 败率: 0.696969696969697 盈亏比: 1.9713099171089428
    # return [po]
    # -0.79
    # return [ma]
    # return [ma5,ma20]
    return [tii,dpo,ma5]


# 年化收益率: OrderedDict([(2011, 0.0), (2012, -0.059182187190000124), (2013, 0.21184097379568878), (2014, 0.1917914917428023), (2015, 0.8007249383493), (2016, -0.1507829522782037), (2017, -0.01127350180272646), (2018, -0.10268130902155193), (2019, 0.33992611896744496), (2020, 0.17938762923141116), (2021, 0.1827567250195965)])
# 夏普: 0.5257240252754136
# 最大回撤:29.56，最大回撤周期1004
# 总收益率:1.24
# 交易次数: 112
# 胜率: 0.4107142857142857 败率: 0.5892857142857143 盈亏比: 3.525653102685943


""" ma5
data_value 262137.51117844973
年化收益率: OrderedDict([(2011, -0.007938832426500175), (2012, 0.010233761908887029), (2013, -0.12366142452873863), (2014, 0.13659573733307662), (2015, 1.0250098180684906), (2016, -0.22646604074242727), (2017, -0.21756692107232212), (2018, 0.05796103639458727), (2019, -0.09556353355830471), (2020, 0.7505433593844804), (2021, 0.2791355227298249)])
夏普: 0.35151833500669705
最大回撤:46.58，最大回撤周期1247
总收益率:0.96
交易次数: 186
胜率: 0.41397849462365593 败率: 0.5860215053763441
盈亏比: 2.2822002481116623
"""
"""ma20
data_value 272350.36263945
年化收益率: OrderedDict([(2011, 0.05835520072700007), (2012, -0.17258149982920046), (2013, 0.16204798930536213), (2014, 0.12020486937152453), (2015, 1.4056166227100029), (2016, -0.08502619346153883), (2017, -0.053214582603560934), (2018, -0.09741017608265712), (2019, -0.09295062872240278), (2020, 0.2834274537649799), (2021, 0.09111478501440273)])
夏普: 0.3277971047566049
最大回撤:36.60，最大回撤周期1340
总收益率:1.00
交易次数: 80
胜率: 0.3 败率: 0.7
盈亏比: 3.8266000019594486

"""

"""ma10
data_value 211283.34056054996
年化收益率: OrderedDict([(2011, -0.05540279060350051), (2012, 0.07559917797568372), (2013, 0.06074719484422464), (2014, 0.15079287000635855), (2015, 1.2323055988683977), (2016, -0.18862706364805404), (2017, -0.13156210704975124), (2018, -0.1829309687189793), (2019, -0.0755184882792782), (2020, 0.4130591994774828), (2021, 0.014679327231191808)])
夏普: 0.28156379252731756
最大回撤:53.11，最大回撤周期1448
总收益率:0.75
交易次数: 123
胜率: 0.34959349593495936 败率: 0.6504065040650406
盈亏比: 2.5374736710897317

"""

"""dpo
data_value 249194.89777194976
年化收益率: OrderedDict([(2011, -0.032343318557000345), (2012, -0.1384265240206377), (2013, 0.31490301785294883), (2014, 0.1377986856013249), (2015, 0.9894534763042517), (2016, -0.11235467599683913), (2017, -0.06979097096513487), (2018, -0.18966418844674449), (2019, -0.056045354782555235), (2020, 0.30943294210207895), (2021, 0.21426407243688783)])
夏普: 0.35414459532280956
最大回撤:51.30，最大回撤周期1539
总收益率:0.91
交易次数: 58
胜率: 0.3275862068965517 败率: 0.6724137931034483
盈亏比: 3.597589112477208
"""

"""er
data_value 146142.69331759986
年化收益率: OrderedDict([(2011, -0.17181432709700017), (2012, -0.2194090555099264), (2013, 0.35500875745773297), (2014, 0.017305650042920284), (2015, 1.1043376267537242), (2016, -0.33921989651700757), (2017, -0.11709263946177895), (2018, -0.23541955578470464), (2019, 0.2151619241656395), (2020, 0.2698515813442268), (2021, 0.132229608233571)])
夏普: 0.21138158819163747
最大回撤:61.93，最大回撤周期1539
总收益率:0.38
交易次数: 73
胜率: 0.2465753424657534 败率: 0.7534246575342466
盈亏比: 3.6019405147275187

"""

"""tii
data_value 122711.95485754998
年化收益率: OrderedDict([(2011, -0.07801998392800003), (2012, -0.05684787414189141), (2013, -0.0007917474526696333), (2014, 0.17640492622832138), (2015, 0.3323588536660562), (2016, -0.03691233574420438), (2017, -0.017891022572558035), (2018, -0.21264406112150436), (2019, 0.09208606375806272), (2020, -0.05371689631514165), (2021, 0.17077920619509301)])
夏普: 0.1289500192848344
最大回撤:38.08，最大回撤周期1328
总收益率:0.20
交易次数: 62
胜率: 0.3709677419354839 败率: 0.6290322580645161
盈亏比: 2.0034108645977753
"""

"""[dpo,ma5]
data_value 954958.2551409983
年化收益率: OrderedDict([(2011, 0.12331368982799984), (2012, 0.11323595871690717), (2013, 0.5765939592614011), (2014, 0.21358240499290826), (2015, 1.582836533768758), (2016, 0.04839466423507677), (2017, -0.05512832712131477), (2018, 0.08078148782191907), (2019, 0.025774803583626937), (2020, 0.19172420397116596), (2021, 0.1807195219337634)])
夏普: 0.6139504437829901
最大回撤:15.01，最大回撤周期919
总收益率:2.26
交易次数: 185
胜率: 0.4810810810810811 败率: 0.5135135135135135
盈亏比: 3.671868550162805
"""

"""[dpo,ma20]
data_value 791529.5985414996
年化收益率: OrderedDict([(2011, 0.12795579502399979), (2012, 0.05698875492069422), (2013, 0.35932935649270004), (2014, 0.25768566348510036), (2015, 1.5855751918371057), (2016, -0.01537629394642015), (2017, -0.05459106055973628), (2018, -0.055130263644516675), (2019, -0.09056174871281752), (2020, 0.513447492385011), (2021, 0.24064699476104412)])
夏普: 0.5614479129706729
最大回撤:31.03，最大回撤周期1027
总收益率:2.07
交易次数: 102
胜率: 0.38235294117647056 败率: 0.6078431372549019
盈亏比: 5.187487939731824
"""

"""[ma5,ma20]
data_value 272350.36263945
年化收益率: OrderedDict([(2011, 0.05835520072700007), (2012, -0.17258149982920046), (2013, 0.16204798930536213), (2014, 0.12020486937152453), (2015, 1.4056166227100029), (2016, -0.08502619346153883), (2017, -0.053214582603560934), (2018, -0.09741017608265712), (2019, -0.09295062872240278), (2020, 0.2834274537649799), (2021, 0.09111478501440273)])
夏普: 0.3277971047566049
最大回撤:36.60，最大回撤周期1340
总收益率:1.00
交易次数: 80
胜率: 0.3 败率: 0.7
盈亏比: 3.8266000019594486
"""

"""[dpo,tii,er]
data_value 463335.72754469974
年化收益率: OrderedDict([(2011, -0.03553384258250025), (2012, -0.005253779032089567), (2013, 0.495813592614023), (2014, 0.1315741260248231), (2015, 1.045696864421806), (2016, -0.13373449826541972), (2017, -0.04412595205461323), (2018, -0.15337460907486944), (2019, 0.21482804559028934), (2020, 0.3355447346285134), (2021, 0.22624855072533046)])
夏普: 0.5374009940003581
最大回撤:35.27，最大回撤周期1120
总收益率:1.53
交易次数: 64
胜率: 0.34375 败率: 0.65625
盈亏比: 5.379329058013095
"""

"""[tii,dpo]
data_value 535015.6512143002
年化收益率: OrderedDict([(2011, -0.015598687722999771), (2012, 0.014096441322190678), (2013, 0.4783127022581719), (2014, 0.22117607235143444), (2015, 0.9126534520037499), (2016, -0.027711697145503256), (2017, -0.021902141675086306), (2018, -0.2164238256985621), (2019, 0.29733332630317033), (2020, 0.2584431327184935), (2021, 0.2758229204402112)])
夏普: 0.6358583516214986
最大回撤:32.38，最大回撤周期936
总收益率:1.68
交易次数: 71
胜率: 0.43661971830985913 败率: 0.5633802816901409
盈亏比: 4.4241127488779775
"""

"""[tii,dpo,ma5]
data_value 1220213.790199899
年化收益率: OrderedDict([(2011, 0.0801293930039999), (2012, 0.08486519619474953), (2013, 0.6550440236607871), (2014, 0.25051250201612385), (2015, 1.3453549943507253), (2016, 0.01155875270758111), (2017, -0.041459155643059464), (2018, -0.09829200983071995), (2019, 0.3168538993138097), (2020, 0.44316901748282556), (2021, 0.29108771241863596)])
夏普: 0.7477503596814425
最大回撤:22.62，最大回撤周期826
总收益率:2.50
交易次数: 100
胜率: 0.37 败率: 0.62
盈亏比: 9.45342961198648
"""